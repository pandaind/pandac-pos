# Alembic Database Migrations Guide - Pandac POS

This guide covers how to use Alembic for database migrations in the Pandac POS project.

## Overview

Alembic is a database migration tool for SQLAlchemy. It allows you to:

- Track database schema changes over time
- Apply and rollback migrations
- Auto-generate migrations from model changes
- Maintain database version control

## Project Setup

The Pandac POS project is already configured with Alembic:

```text
alembic/
├── env.py                 # Alembic environment configuration
├── script.py.mako        # Migration template
└── versions/             # Migration files directory
    └── 196993effbf8_add_is_active_field_to_users.py
alembic.ini               # Alembic configuration file
```

## Prerequisites

Before using Alembic, ensure:

1. **Database is running**:
   ```bash
   docker-compose up -d db
   ```

2. **Environment variables are set** (`.env` file):
   ```env
   DATABASE_URL=postgresql://username:password@localhost:5432/pandac_pos
   ```

3. **Dependencies are installed**:
   ```bash
   pip install alembic sqlalchemy psycopg2-binary
   ```

## Common Alembic Commands

### 1. Check Current Migration Status

```bash
# Check current database version
alembic current

# Show migration history
alembic history --verbose

# Show pending migrations
alembic show head
```

### 2. Apply Migrations

```bash
# Apply all pending migrations to latest
alembic upgrade head

# Apply migrations to a specific revision
alembic upgrade <revision_id>

# Apply one migration at a time
alembic upgrade +1
```

### 3. Create New Migrations

#### Auto-generate Migration (Recommended)
```bash
# Auto-generate migration from model changes
alembic revision --autogenerate -m "description of changes"

# Example:
alembic revision --autogenerate -m "add customer loyalty points field"
```

#### Manual Migration
```bash
# Create empty migration file
alembic revision -m "manual migration description"
```

### 4. Rollback Migrations

```bash
# Rollback to previous migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade <revision_id>

# Rollback all migrations
alembic downgrade base
```

## Step-by-Step Workflow

### Making Model Changes and Creating Migrations

1. **Modify your models** in `app/models/`:
   ```python
   # Example: Add a field to Customer model
   class Customer(BaseModel):
       __tablename__ = "customers"
       
       name = Column(String, nullable=False)
       email = Column(String, unique=True, nullable=False)
       phone = Column(String, nullable=True)
       loyalty_points = Column(Integer, default=0)  # New field
   ```

2. **Generate migration**:
   ```bash
   alembic revision --autogenerate -m "add loyalty points to customers"
   ```

3. **Review the generated migration** in `alembic/versions/`:
   ```python
   def upgrade() -> None:
       # ### commands auto generated by Alembic - please adjust! ###
       op.add_column('customers', sa.Column('loyalty_points', sa.Integer(), nullable=True))
       # ### end Alembic commands ###
   
   def downgrade() -> None:
       # ### commands auto generated by Alembic - please adjust! ###
       op.drop_column('customers', 'loyalty_points')
       # ### end Alembic commands ###
   ```

4. **Apply the migration**:
   ```bash
   alembic upgrade head
   ```

### Project-Specific Examples

#### Adding a New Table

1. **Create the model** in `app/models/`:
   ```python
   class LoyaltyProgram(BaseModel):
       __tablename__ = "loyalty_programs"
       
       name = Column(String, nullable=False)
       points_per_dollar = Column(Float, default=1.0)
       min_points_redemption = Column(Integer, default=100)
   ```

2. **Import in models/__init__.py**:
   ```python
   from .loyalty import LoyaltyProgram
   ```

3. **Generate migration**:
   ```bash
   alembic revision --autogenerate -m "add loyalty programs table"
   ```

4. **Apply migration**:
   ```bash
   alembic upgrade head
   ```

#### Modifying Existing Columns

```bash
# Example: Change column type or add constraints
alembic revision --autogenerate -m "modify customer email column"
```

#### Adding Indexes

```bash
# Alembic will detect index changes in models
alembic revision --autogenerate -m "add index to customer email"
```

## Docker Environment Usage

### Running Alembic in Docker

If your application runs in Docker, you have several options:

#### Option 1: Run from Host (Recommended for Development)
```bash
# Ensure database is accessible from host
alembic upgrade head
```

#### Option 2: Execute in Container
```bash
# Run migration inside the API container
docker-compose exec api alembic upgrade head

# Generate migration in container
docker-compose exec api alembic revision --autogenerate -m "description"
```

#### Option 3: Migration on Startup
The project includes automatic migrations in the startup script. Check `start.sh` or `main.py` for:
```python
# Automatic migration on startup (if configured)
from alembic.config import Config
from alembic import command

def run_migrations():
    alembic_cfg = Config("alembic.ini")
    command.upgrade(alembic_cfg, "head")
```

## Best Practices

### 1. Always Review Auto-Generated Migrations
```bash
# After generating, always check the migration file
alembic revision --autogenerate -m "description"
# Then edit alembic/versions/<revision>_description.py if needed
```

### 2. Test Migrations
```bash
# Apply migration
alembic upgrade head

# Test rollback
alembic downgrade -1

# Re-apply
alembic upgrade head
```

### 3. Backup Before Major Changes
```bash
# Backup database before major migrations
pg_dump pandac_pos > backup_before_migration.sql
```

### 4. Use Descriptive Messages
```bash
# Good
alembic revision --autogenerate -m "add foreign key constraint to orders table"

# Bad  
alembic revision --autogenerate -m "update"
```

## Troubleshooting

### Common Issues and Solutions

#### 1. "Target database is not up to date"
```bash
# Check current status
alembic current
alembic history

# Apply pending migrations
alembic upgrade head
```

#### 2. "Can't locate revision identified by"
```bash
# Reset alembic version table
alembic stamp head
```

#### 3. Migration Conflicts
```bash
# If you have multiple migration branches
alembic merge -m "merge branches" <rev1> <rev2>
```

#### 4. Database Connection Issues
```bash
# Check your DATABASE_URL in .env
echo $DATABASE_URL

# Test database connection
python -c "from app.core.database import engine; print(engine.execute('SELECT 1').scalar())"
```

### Manual Migration Recovery

If migrations are corrupted or you need to start fresh:

```bash
# 1. Backup current data
pg_dump pandac_pos > backup.sql

# 2. Drop and recreate database
dropdb pandac_pos
createdb pandac_pos

# 3. Run all migrations
alembic upgrade head

# 4. Restore data (if needed)
psql pandac_pos < backup.sql
```

## Environment-Specific Usage

### Development
```bash
# Generate and apply migrations frequently
alembic revision --autogenerate -m "dev changes"
alembic upgrade head
```

### Production
```bash
# Always test migrations in staging first
# Apply with explicit revision for safety
alembic upgrade <specific_revision>

# Or use the safer head approach
alembic upgrade head
```

## Integration with CI/CD

Example GitHub Actions workflow for migrations:

```yaml
- name: Run Database Migrations
  run: |
    alembic upgrade head
  env:
    DATABASE_URL: ${{ secrets.DATABASE_URL }}
```

## Useful Commands Summary

| Command | Description |
|---------|-------------|
| `alembic current` | Show current migration version |
| `alembic history` | Show migration history |
| `alembic revision --autogenerate -m "msg"` | Generate migration from model changes |
| `alembic upgrade head` | Apply all pending migrations |
| `alembic downgrade -1` | Rollback one migration |
| `alembic show <revision>` | Show specific migration details |
| `alembic stamp head` | Mark database as up-to-date without running migrations |

## Files and Configuration

- **`alembic.ini`**: Main configuration file
- **`alembic/env.py`**: Environment setup (database connection, models import)
- **`alembic/versions/`**: Migration files directory
- **`.env`**: Database connection string

Remember to always test your migrations in a development environment before applying them to production!

## Quick Reference Card

### Most Common Commands

```bash
# Check status
alembic current
alembic history

# Create migration
alembic revision --autogenerate -m "description"

# Apply migrations
alembic upgrade head

# Rollback
alembic downgrade -1
```

### Emergency Commands

```bash
# Mark database as current without running migrations
alembic stamp head

# Reset to specific revision
alembic downgrade <revision_id>
alembic upgrade <revision_id>
```

### Development Workflow

1. Modify models in `app/models/`
2. `alembic revision --autogenerate -m "description"`
3. Review generated migration file
4. `alembic upgrade head`
5. Test the changes
6. Commit migration file to version control
